addr = &6000
color1 = &fe08
color2 = &fe09
oswrch = &ffee
bar_delay_count = &70
bar_delay_direction = &71
old_irq = &72
ORG &3000

.start    
    ; set mode 4
    lda #22 : jsr oswrch : lda #4 : jsr oswrch

    ; need equivalent of VDU23,1,0;0;0;0; here to turn off cursor
    lda #23 : jsr oswrch : lda #1 : jsr oswrch
    lda #0 : jsr oswrch : jsr oswrch : jsr oswrch : jsr oswrch : jsr oswrch : jsr oswrch : jsr oswrch : jsr oswrch

    ; keyboard off
    ; *fx 178,0,0
    lda #0
    sta &242

    ; plus 1 off
    lda #&d6
    sta &212
    lda #&f1
    sta &213
    lda #0
    sta &2a0+12

    sei
    ; enable only rtc (8) & vsync (4) interrupts
    lda #12
    sta &fe00

    lda &204
    sta old_irq
    lda &205
    sta old_irq + 1
    lda #irq_handler MOD 256
    sta &204
    lda #irq_handler DIV 256
    sta &205

    lda #128
    sta bar_delay_count
    lda #0
    sta bar_delay_direction
    rts

.irq_handler
    php
    lda &fe00
    and #4
    bne vsync

    ; probably rtc - clear and return
    plp
    lda &fc
    rti

    ; vsync interrupt
.vsync
    ; disable interrupts - we're doing everything by counting cycles from now on!
    lda #0 ; 2
    sta &fe00 ; 4

    ; set black background
    lda #255 ; 2
    sta color1 ; 4
    lda #255 ; 2
    sta color2 ; 4
    ldx #61 ; 2

.wait_for_screen_start    
    jsr wait_one_scanline ; 6
    dex ; 2
    bne wait_for_screen_start ; 3 or 2 if fall through

    ; 60 * (9 + 42) + (8 + 42) = 3110 cycles + 20 = 3130 cycles since vsync ?

    ; set red background
    lda #84
    sta color1
    lda #20
    sta color2
    jsr wait_one_scanline

    lda #255
    sta color1
    lda #255
    sta color2
    plp
    lda &fc
    rti

    ; wait we see a red line on the screen
    jsr wait_one_scanline
    jsr wait_one_scanline
    jsr wait_one_scanline
    jsr wait_one_scanline
    jsr wait_one_scanline

.wait_and_draw
.draw_bars
    ; set red background for 4 lines
    lda #255
    sta color1
    lda #255
    sta color2
    jsr wait_one_scanline
    lda #255
    sta color1
    lda #255
    sta color2
    jsr wait_one_scanline
    lda #255
    sta color1
    lda #255
    sta color2
    jsr wait_one_scanline
    lda #255
    sta color1
    lda #255
    sta color2
    jsr wait_one_scanline

    ; set black background
    ldx #252 ; black for 252 lines
.blank_loop    
    lda #84
    sta color1
    lda #20
    sta color2
    jsr wait_one_scanline
    dex
    bne blank_loop

    jmp wait_and_draw ; 3 cycles

; 1 scan line = 64us
; this delay is enough to skip 1 scan line at a time
.wait_one_scanline
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    rts ; NOP=2 cycles, RTS=6 => 21*2 + 6 => 42 + 6 (jsr) = 48 cycles = 1 mode 4 scan line?

.end
    RTS

SAVE "raster", start, end