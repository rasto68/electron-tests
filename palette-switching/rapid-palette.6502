addr = &6000
color1 = &fe08
color2 = &fe09
oswrch = &ffee
bar_delay_count = &70
bar_delay_direction = &71
old_irq = &72
ORG &3000

.start    
    ; set mode 4
    lda #22 : jsr oswrch : lda #4 : jsr oswrch

    ; need equivalent of VDU23,1,0;0;0;0; here to turn off cursor
    lda #23 : jsr oswrch : lda #1 : jsr oswrch
    lda #0 : jsr oswrch : jsr oswrch : jsr oswrch : jsr oswrch : jsr oswrch : jsr oswrch : jsr oswrch : jsr oswrch

    ; keyboard off
    ; *fx 178,0,0
    lda #0
    sta &242

    ; plus 1 off
    lda #&d6
    sta &212
    lda #&f1
    sta &213
    lda #0
    sta &2a0+12

    sei
    ; enable only vsync interrupts
    lda #4
    sta &fe00

    lda &204
    sta old_irq
    lda &205
    sta old_irq + 1
    lda #irq_handler MOD 256
    sta &204
    lda #irq_handler DIV 256
    sta &205

    lda #128
    sta bar_delay_count
    lda #0
    sta bar_delay_direction
    lda #255
    sta &7f
    rts

.irq_handler
    php ; 3
    ; vsync interrupt
.vsync
    ; set black background
    lda #255 ; 2
    sta color1 ; 4
    lda #255 ; 2
    sta color2 ; 4
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop ; 48 nop cycles
    ldx #59 ; 2
    ; 65 cycles to here from irq_handler

.wait_for_screen_start    
    jsr wait_one_scanline ; 6 + 42
    dex ; 2
    bne wait_for_screen_start ; 3 or 2 if fall through

    ; 65 + 58 * (48 + 2 + 3) + (48 + 2 + 2)
    ; 3191 cycles to here from irq_handler

    ; set red background
    lda #84
    sta color1
    lda #20
    sta color2
    jsr wait_one_scanline_2
    lda #84
    sta color1
    lda #20
    sta color2
    jsr wait_one_scanline_2
    lda #84
    sta color1
    lda #20
    sta color2
    jsr wait_one_scanline_2
    lda #84
    sta color1
    lda #20
    sta color2
    jsr wait_one_scanline_2

    ; set yellow background
    lda #84
    sta color1
    lda #4
    sta color2
    jsr wait_one_scanline_2
    lda #84
    sta color1
    lda #4
    sta color2
    jsr wait_one_scanline_2
    lda #84
    sta color1
    lda #4
    sta color2
    jsr wait_one_scanline_2
    lda #84
    sta color1
    lda #4
    sta color2
    jsr wait_one_scanline_2

    ; set blue background
    lda #68
    sta color1
    lda #21
    sta color2
    jsr wait_one_scanline_2
    lda #68
    sta color1
    lda #21
    sta color2
    jsr wait_one_scanline_2
    lda #68
    sta color1
    lda #21
    sta color2
    jsr wait_one_scanline_2
    lda #68
    sta color1
    lda #21
    sta color2
    jsr wait_one_scanline_2

    ; set cyan background
    lda #68
    sta color1
    lda #5
    sta color2    
    jsr wait_one_scanline_2
    lda #68
    sta color1
    lda #5
    sta color2    
    jsr wait_one_scanline_2
    lda #68
    sta color1
    lda #5
    sta color2    
    jsr wait_one_scanline_2
    lda #68
    sta color1
    lda #5
    sta color2    
    jsr wait_one_scanline_2

    ; set green background
    lda #84
    sta color1
    lda #5
    sta color2
    jsr wait_one_scanline_2
    lda #84
    sta color1
    lda #5
    sta color2
    jsr wait_one_scanline_2
    lda #84
    sta color1
    lda #5
    sta color2
    jsr wait_one_scanline_2
    lda #84
    sta color1
    lda #5
    sta color2
    jsr wait_one_scanline_2

    ; set magenta background
    lda #68
    sta color1
    lda #20
    sta color2
    jsr wait_one_scanline_2
    lda #68
    sta color1
    lda #20
    sta color2
    jsr wait_one_scanline_2
    lda #68
    sta color1
    lda #20
    sta color2
    jsr wait_one_scanline_2
    lda #68
    sta color1
    lda #20
    sta color2
    jsr wait_one_scanline_2

    ; set white background
    lda #9
    sta color1
    lda #0
    sta color2    
    jsr wait_one_scanline_2
    lda #9
    sta color1
    lda #0
    sta color2    
    jsr wait_one_scanline_2
    lda #9
    sta color1
    lda #0
    sta color2    
    jsr wait_one_scanline_2
    lda #9
    sta color1
    lda #0
    sta color2    
    jsr wait_one_scanline_2

    ; back to black
    lda #255
    sta color1
    lda #255
    sta color2

    lda #16
    sta &fe05
    plp
    lda &fc
    rti

; 1 scan line = 64us
; this delay is enough to skip 1 scan line at a time
.wait_one_scanline
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    rts ; NOP=2 cycles, RTS=6 => 21*2 + 6 => 42 + 6 (jsr) = 48 cycles = 1 mode 4 scan line?

.wait_one_scanline_2
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    rts ; NOP=2 cycles, RTS=6 => 21*2 + 6 => 42 + 6 (jsr) = 48 cycles = 1 mode 4 scan line?

.end
    RTS

SAVE "raster", start, end